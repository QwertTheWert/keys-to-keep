{% extends 'navbar_template.html' %}

{% block head %}
	<title>Cart</title>
	<link rel="stylesheet" href="{{ url_for('cart.static', filename='cart.css') }}">
{% endblock %}

{% block content %}
	<div class="page_container">
		<div class="cart-container">
			<h2>Shopping Cart</h2>
			{% if cart_data != [] %}
				{% for data in cart_data %}
					<div class="cart-item" id="cart-item-{{ data.cart.id }}">
						<img src="{{ url_for('static', filename='assets/Vortex series 82.png') }}" alt="Product">
						<div class="item-details">
							<h3> {{data.product.name}} ({{ data.product_model.name }}) </h3>
							<p> {{ data.product_model.slogan }} </p>
							<p >
								Rp. 
								<span id="price-unit-{{ data.cart.id }}">{{ data.price }}</span>
								 Ã— 
								<span id="price-qty-{{ data.cart.id }}">{{ data.cart.quantity }}</span>
								 = Rp. 
								 <span id="subtotal-{{ data.cart.id }}">{{ data.subtotal }}</span> </p>
							<div class="quantity">
								<button 
									class="qty-btn" data-action="decrease" data-id="{{ data.cart.id }}" id="qty-down-{{ data.cart.id }}"
									{% if data.cart.quantity == 0 %} disabled="true" {% endif %}
								>
									-
								</button>
								<input class="qty-field" type="text" value="{{ data.cart.quantity }}" data-id="{{ data.cart.id }}" id="qty-{{ data.cart.id }}">
								<button 
									class="qty-btn" data-action="increase" data-id="{{ data.cart.id }}" id="qty-up-{{ data.cart.id }}"
									{% if data.is_max %} disabled="true" {% endif %}
								>
									+
								</button>
							</div>
						</div>
						<button class="remove" data-id="{{ data.cart.id }}" >Remove</button>
					</div>
				{% endfor %}
			{% else %}
			<div class="cart-item">Cart is Empty</div>
			{% endif %}
			
		</div>

		<div class="Total_Price_container">
			<h3>Total: Rp. <span id="total">{{ total }}</span></h3>
			<button class="checkout" id="checkout" {% if cart_data %} disabled="true" {% endif %}>Proceed to Checkout</button>
		</div>
		
	</div>

<script>

	document.querySelectorAll('.qty-field').forEach(field => {
		field.addEventListener('keydown', function (event) {
			if (event.key === "Enter") {
				
				onQuantityFieldSet(this);
			}
		});
	});

	document.querySelectorAll('.qty-btn').forEach(btn => {
		btn.addEventListener('click', function() {
			const action = this.dataset.action;
			const cartID = this.dataset.id;
			const total = document.getElementById("total").textContent.replace(/\./g, '');

			fetch(`cart/increment_quantity`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ cart_id: cartID, action: action, total : total }),
			})
			.then(response => response.json())
			.then(data => {
				update_price_display(data, cartID);
			});
		});
	});

	document.querySelectorAll('.remove').forEach(remove_btn => {
		remove_btn.addEventListener('click', function () {
		const cartID = this.dataset.id;
		const total = document.getElementById("total").textContent.replace(/\./g, '');

		fetch(`cart/remove`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({ cart_id: this.dataset.id, total : total }),
		})
		.then(response => response.json())
		.then(data => {
			document.getElementById(`cart-item-${cartID}`).remove();
			document.getElementById(`total`).textContent  = data.new_total;
			if (document.getElementsByClassName('.cart-item').length == 0) {
				document.getElementById("checkout").disabled = true;
			}
		});
	});
	});

	function onQuantityFieldSet(field) {
		const value = field.value;
		const cartID = field.dataset.id;
		const total = document.getElementById("total").textContent.replace(/\./g, '');

		
		fetch(`cart/set_quantity`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({ cart_id: cartID, value: value, total : total }),
		})
		.then(response => response.json())
		.then(data => {
			update_price_display(data, cartID);
		});
	}

	function update_price_display(data, cartID) {
		document.getElementById(`qty-${cartID}`).value = data.new_quantity;
		document.getElementById(`price-qty-${cartID}`).textContent  = data.new_quantity;
		document.getElementById(`subtotal-${cartID}`).textContent  = data.new_subtotal;
		document.getElementById(`total`).textContent  = data.new_total;
		document.getElementById(`qty-down-${cartID}`).disabled = (data.status == "min");
		document.getElementById(`qty-up-${cartID}`).disabled = (data.status == "max");
	}
</script>

{% endblock %}